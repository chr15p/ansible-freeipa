---
- name: Test automountmap
  hosts: ipaserver
  become: true
  gather_facts: false

  tasks:
  - name: ensure location TestLocation is absent
    ipaautomountlocation:
      ipaadmin_password: password01
      name: TestLocation
      state: absent

  - name: ensure map TestMap is absent
    ipaautomountmap:
      ipaadmin_password: password01
      name: TestMap
      location: TestLocation
      state: absent

  - name: ensure key TestKey is absent
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      state: absent


### create the environment for the tests
  - name: create location TestLocation
    ipaautomountlocation:
      ipaadmin_password: password01
      name: TestLocation
      state: present

  - name: ensure location TestLocation has been created
    ipaautomountlocation:
      ipaadmin_password: password01
      name: TestLocation
      state: present
    register: result
    failed_when: result.changed

  - name: create map TestMap 
    ipaautomountmap:
      ipaadmin_password: password01
      name: TestMap
      location: TestLocation
      desc: "this is a test map that should be deleted by the test"

  - name: ensure map TestMap has been created
    ipaautomountmap:
      ipaadmin_password: password01
      name: TestMap
      location: TestLocation
    register: result
    failed_when: result.changed

### test the key creation, and modification
  - name: create key TestKey
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      automountinformation: 192.168.122.1:/exports
      state: present

  - name: ensure key TestKey has been created
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      automountinformation: 192.168.122.1:/exports
      state: present
    register: result
    failed_when: result.changed

## modify the key
  - name: create key TestKey
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      automountinformation: 192.168.122.1:/nfsshare
      state: present

  - name: ensure key TestKey has been created
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      automountinformation: 192.168.122.1:/nfsshare
      state: present
    register: result
    failed_when: result.changed


### cleanup after the tests

  - name: ensure key TestKey is absent
    ipaautomountkey:
      ipaadmin_password: password01
      automountlocationcn: TestLocation
      automountmapname: TestMap
      automountkey: TestKey
      state: absent


  - name: ensure map TestMap is removed
    ipaautomountmap:
      ipaadmin_password: password01
      name: TestMap
      location: TestLocation
      state: absent

  - name: ensure map TestMap has been removed
    ipaautomountmap:
      ipaadmin_password: password01
      name: TestMap
      location: TestLocation
      state: absent
    register: result
    failed_when: result.changed



  - name: ensure location TestLocation is removed
    ipaautomountlocation:
      ipaadmin_password: password01
      name: TestLocation
      state: absent

  - name: ensure location TestLocation is absent
    ipaautomountlocation:
      ipaadmin_password: password01
      name: TestLocation
      state: absent
    register: result
    failed_when: result.changed

